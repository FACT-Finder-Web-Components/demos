<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ASN "Apply Filters" Demo</title>
  <link rel="stylesheet" href="../assets/demo-styles.css">

  <script src="../node_modules/ff-web-components/dist/vendor/custom-elements-es5-adapter.js"></script>
  <script src="../node_modules/ff-web-components/dist/vendor/webcomponents-loader.js"></script>
  <script defer src="../node_modules/ff-web-components/dist/bundle.js"></script>

  <style>
    main {
      display: flex;
      padding: 0 10px;
    }

    .filters {
      flex: 0 0;
      width: 240px;
      margin-right: 10px;
    }

    .products-listing {
      flex: 1 0;
    }

    ff-record-list {
      margin-right: -10px;
    }
  </style>

  <script>
    const difference = (a, b) => a.filter(x => !b.includes(x));
    const symmetricDifference = (a, b) => difference(a, b).concat(difference(b, a));

    function createButton() {
      const button = document.createElement('button');
      button.textContent = 'Apply filters';
      button.classList.add('btn');
      button.enable = () => {
        button.disabled = false;
        button.classList.add('btn--pending');
      }
      button.disable = () => {
        button.disabled = true;
        button.classList.remove('btn--pending');
      }
      return button;
    }

    const currentSelection = eventAggregator => filter => {
      const values = eventAggregator.currentSearchResult.filters.find(f => f.name === filter) || {valueList: []};
      return values.valueList.map(v => v.value);
    }

    const pendingSelection = grp => {
      return Array.from(grp.querySelectorAll('ff-asn-group-element')).filter(g => g.selected).map(g => g.element);
    }

    const hasPending = (group, currentSelection) => {
      const pending = pendingSelection(group).map(e => e.name);
      const current = currentSelection('Manufacturer');
      return symmetricDifference(pending, current).length > 0;
    }

    const applyFilters = (group, button, eventAggregator) => () => {
      const selected = pendingSelection(group);

      if (selected.length) {
        const groupName = selected[0].associatedFieldName;
        const params = factfinder.common.parameterStringToDict(location.search.substr(1));

        eventAggregator.addFFEvent({
          ...params,
          type: 'search',
          filter: Array.from(new Set([
            ...(params.filter || []).map(f => decodeURIComponent(f)).filter(f => !f.startsWith(`${groupName}:`)),
            ...selected.map(e => `${e.associatedFieldName}:${e.name}`),
          ])),
          success: () => button.disable(),
        });
      } else {
        eventAggregator.addFFEvent({
          type: 'filter',
          groupName: group.group.name,
          removeAll: true,
          success: () => button.disable(),
        });
      }
    }

    document.addEventListener('ffReady', function (event) {
      const eventAggregator = event.eventAggregator;

      function addButton(e) {
        const brand = e.target.querySelector('ff-asn-group[for-group="Brand"]');
        const links = brand && brand.querySelector('[data-container="detailedLinks"]');

        if (links) {
          // Add "Apply filters" button
          const button = createButton();
          button.onclick = applyFilters(brand, button, eventAggregator);
          button.disable();
          links.parentNode.append(button);

          document.querySelector('ff-asn').removeEventListener('dom-updated', addButton);

          // Deactivate regular behavior (Filter on click)
          eventAggregator.addBeforeDispatchingCallback(function (event) {
            if (event.type === 'filter' && event.groupName === encodeURIComponent('Brand')) {
              if (event.filterName) {
                event.cancel();
                hasPending(brand, currentSelection(eventAggregator)) ? button.enable() : button.disable();
              } else {
                // Reset filter
                event.success = () => button.disable();
              }

            }
          })
        }
      }

      document.querySelector('ff-asn').addEventListener('dom-updated', addButton);
    });
  </script>
</head>
<body>

<ff-communication url="https://showcase.ff-labs.de/fact-finder"
                  version="ng"
                  channel="Bergfreunde-en"
                  currency-code="EUR"
                  currency-country-code="de-DE"
                  default-query="boots"
                  search-immediate
                  only-search-params
></ff-communication>

<div class="searchbar">
  <ff-searchbox use-suggest="false">
    <input placeholder="Search..." autofocus />
    <ff-searchbutton>
      <button>
        <span class="icon-search"></span>
      </button>
    </ff-searchbutton>
  </ff-searchbox>
</div>

<main>
  <div class="filters">
    <ff-asn-remove-all-filter>Reset all filters</ff-asn-remove-all-filter>
    <ff-asn unresolved>

      <ff-asn-group for-group="all">
        <ff-asn-group-element>
          <div slot="selected">
            <span class="checkbox"></span> {{element.name}}&nbsp;{{group.unit}}
          </div>

          <div slot="unselected">
            <span class="checkbox"></span>
            <span>{{element.name}}&nbsp;{{group.unit}}</span>
            <span>({{element.recordCount}})</span>
          </div>
        </ff-asn-group-element>

        <div slot="groupCaption" class="expand-arrow"><div>{{group.name}}</div></div>

        <div data-container="detailedLinks">
          <div data-content="detailedLinks"></div>
        </div>

        <div data-container="hiddenLinks">
          <div data-content="hiddenLinks"></div>
        </div>

        <div data-container="removeFilter">[x] Reset Filter</div>
      </ff-asn-group>

      <ff-asn-group filter-style="TREE" collapsible="false" opened>
        <ff-asn-group-element>
          <div slot="selected">{{element.name}}&nbsp;{{group.unit}}</div>
          <div slot="unselected">
            <p>{{element.name}}&nbsp;{{group.unit}} <span class="count">({{element.recordCount}})</span>
            </p>
          </div>
        </ff-asn-group-element>

        <div slot="groupCaption"><div>{{group.name}}</div></div>

        <div data-container="removeFilter">[x] Reset Filter</div>
      </ff-asn-group>

      <ff-asn-group filter-style="DEFAULT">
        <ff-asn-group-element>
          <div slot="selected">
            <span class="circle"></span> {{element.name}}&nbsp;{{group.unit}}
          </div>

          <div slot="unselected">
            <span class="circle"></span>
            <span>{{element.name}}&nbsp;{{group.unit}}</span>
            <span>({{element.recordCount}})</span>
          </div>
        </ff-asn-group-element>

        <div slot="groupCaption" class="expand-arrow"><div>{{group.name}}</div></div>

        <div data-container="detailedLinks">
          <div data-content="detailedLinks"></div>
        </div>
        <div data-container="hiddenLinks">
          <div data-content="hiddenLinks"></div>
        </div>

        <div data-container="removeFilter">[x] Reset Filter</div>
      </ff-asn-group>

      <ff-asn-group-slider for-group="Price" class="one-touch-slider" opened>
                <div slot="groupCaption" class="expand-arrow"><div>{{group.name}}</div></div>

        <div data-container="removeFilter">[x] Reset Filter</div>

        <ff-slider-control submit-on-input="true">
          <div class="slider-inputs">
            <input data-control='1'
                   ssstyle="position: absolute; left: 15px;top:12px;">
            <input data-control='2'
                   ssstyle="position: absolute; right: 15px;top:12px;">
          </div>

          <ff-slider-one-touch></ff-slider-one-touch>
        </ff-slider-control>
      </ff-asn-group-slider>

      <ff-asn-group-slider>
        <div slot="groupCaption" class="expand-arrow"><div>{{group.name}}</div></div>

        <div data-container="removeFilter">[x] Reset Filter</div>

        <ff-slider-control submit-on-input="true">
          <input data-control='1'
                 style="position: absolute; left: 15px;top:12px;">
          <input data-control='2'
                 style="position: absolute; right: 15px;top:12px;">

          <ff-slider current-min-value="0">
            <div slot="slider1"></div>
            <div slot="slider2"></div>
          </ff-slider>
        </ff-slider-control>
      </ff-asn-group-slider>

    </ff-asn>
  </div>
  <div class="products-listing">
    <ff-record-list unresolved>
      <ff-record>
        <a data-anchor="https://www.alpinetrek.co.uk{{record.Deeplink}}"
           data-redirect="https://www.alpinetrek.co.uk{{record.Deeplink}}" data-redirect-target="_blank">
          <div class="record-img">
            <img data-image="https://showcase-phoenix.ff-labs.de/demoshop-images/{{record.ImageName}}">
          </div>
          <div class="record-product-info">
            <h3 class="record-product-name">
              {{record.Title}}
            </h3>
            <div class="record-product-brand">{{record.Manufacturer}}</div>
            <div class="record-product-price">{{record.Price}}</div>
          </div>
        </a>
        <div class="record-product-add-to-cart">
          <button>Add to Cart</button>
        </div>
      </ff-record>
    </ff-record-list>
  </div>
</main>
</body>
</html>
