<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multi-Channel Concatenated Records</title>
    <link rel="stylesheet" href="../assets/demo-styles.css">

    <style>
        body {
            width: 1040px;
        }
        main {
            display: flex;
            padding: 0 10px;
        }
        .filters {
            flex: 0 0;
            width: 240px;
            margin-right: 10px;
        }
        .products-listing {
            flex: 1 0;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            padding-left: 10px;
            margin-bottom: 2rem;
        }

        ff-searchbox {
            border-color: #b9b9b9;
        }

        ff-sortbox {
            border: 1px solid #b9b9b9;
            min-width: 200px;
            position: relative;
        }
        ff-sortbox[opened] .ffw-dropdown-container {
            border: 1px solid #b9b9b9;
            left: -1px;
            right: -1px;
        }
        ff-sortbox-item {
            padding: 10px;
            min-width: 200px;
        }
        ff-sortbox[opened] .ffw-dropdown-container ff-sortbox-item:hover {
            color: #2c72ac;
        }
        ff-sortbox-item.ffw-selected {
            font-weight: bold;
            min-width: 200px;
        }

        ff-paging-item {
            padding: 10px;
        }
        ff-paging-item:hover {
            color: #2c72ac;
        }

        ff-products-per-page-list {
            border: 1px solid #b9b9b9;
        }
        ff-products-per-page-list .ffw-selected {
            font-weight: bold;
        }
        ff-products-per-page-item {
            padding: 10px;
        }
        ff-products-per-page-item:hover {
            color: #2c72ac;
        }

        ff-record-list {
            margin-right: -10px;
        }
        ff-record {
            position: relative;
        }
        ff-record .tag-secondary {
            position: absolute;
            top: 120px;
            transform: rotate(-15deg);
            width: 100%;
            text-align: center;
            text-shadow: 1px 1px #f00;
        }
    </style>

    <script>
        document.addEventListener(`ffCoreReady`, ({ factfinder }) => {
            // List of secondary channels that shall be queried with every search request.
            // Any number of channels works.
            // Results will be appended to the primary channel's results in the order of this list.
            const secondaryChannels = [
                `Bergfreunde-de`,
            ];

            const defs = factfinder.config.defaults.general;

            defs.url = `https://showcase.ff-labs.de/fact-finder`;
            defs.channel = `Bergfreunde-en`;


            // The before.search handler is set up to only run for the main channel's initial request.
            // The initial request will be cancelled and reissued together with requests to all secondary channels.
            // Cancelling and reissuing is necessary to prevent the initial request's response to get dispatched
            // to the response pipeline before the secondary channels' requests return.

            factfinder.request.before.search(info => {
                Promise.all([defs.channel, ...secondaryChannels].map(async channel => {
                    const searchOptions = {
                        ...info.searchOptions,
                        requestOptions: {
                            ...info.searchOptions.requestOptions,
                            channel,

                            // Prevents automatic dispatching to the response pipeline. We are going to dispatch
                            // our custom response manually.
                            requestOnly: true,

                            // IMPORTANT: As we are issuing search requests from the before.search handler,
                            // we must prevent that those requests trigger the handler again which would cause an infinite loop.
                            skipBeforeHandlers: true,
                        },
                    };

                    if (channel !== defs.channel) {
                        searchOptions.searchControlParams = {
                            ...searchOptions.searchControlParams,

                            // Optimizations to reduce workload on FactFinder, bandwidth usage and response times.
                            // We only apply these to the secondary channels as we need the main channel's full response.
                            useAsn: false,
                            useCampaigns: false,
                        };
                    }

                    const searchResult = await factfinder.request.search(info.searchParams, searchOptions);

                    // OPTIONAL: Add data to identify the record's origin. For highlighting in the HTML template.
                    searchResult.hits.forEach(hit => hit._secondaryChannel = channel !== defs.channel);

                    return searchResult;
                })).then(([...results]) => {

                    const mainResult = results[0];
                    mainResult.hits = results.flatMap(res => res.hits);

                    // Starts the response pipeline with our custom response at the earliest entry point.
                    // This is the same entry point a direct response from FactFinder would use.
                    factfinder.response.dispatch.search(mainResult);
                });

                // Returning `false` cancels the request pipeline and no request will be sent.
                // Instead, we reissue the request above.
                return false;
            });


            factfinder.request.search({ query: `shirt` }, { requestOptions: { origin: `searchImmediate` } });
        });
    </script>

    <script src="../node_modules/ff-web-components/dist/vendor/custom-elements-es5-adapter.js"></script>
    <script src="../node_modules/ff-web-components/dist/vendor/webcomponents-loader.js"></script>
    <script defer src="../node_modules/ff-web-components/dist/bundle.js"></script>
</head>

<body>

<div class="searchbar">
    <ff-searchbox use-suggest="false" unresolved>
        <input placeholder="Search..." autofocus />
        <ff-searchbutton>
            <button>
                <span class="icon-search"></span>
            </button>
        </ff-searchbutton>
    </ff-searchbox>
</div>

<main>
    <div class="filters">
        <ff-asn unresolved></ff-asn>
    </div>
    <div class="products-listing">
        <div class="controls">
            <ff-sortbox unresolved></ff-sortbox>
            <ff-paging unresolved>
                <ff-paging-item type="currentLink -2">{{caption}}</ff-paging-item>
                <ff-paging-item type="currentLink -1">{{caption}}</ff-paging-item>
                <ff-paging-item type="currentLink" style="font-weight: bold;">{{caption}}</ff-paging-item>
                <ff-paging-item type="currentLink +1">{{caption}}</ff-paging-item>
                <ff-paging-item type="currentLink +2">{{caption}}</ff-paging-item>
            </ff-paging>
            <ff-products-per-page-list values="12,24,36" default-value="12" unresolved></ff-products-per-page-list>
        </div>

        <ff-record-list unresolved>
            <ff-record>
                <div class="record-img">
                    <img data-image="{{variantValues.0.ImageURL}}">
                </div>
                <div class="record-product-info">
                    <h3 class="record-product-name">
                        {{variantValues.0.Title}}
                    </h3>
                    <div class="record-product-brand">{{variantValues.0.Manufacturer}}</div>
                    <div class="record-product-price">{{variantValues.0.Price}}</div>
                </div>
                <div class="record-product-add-to-cart">
                    <button>Add to Cart</button>
                </div>
                {{#_secondaryChannel}}
                <div class="tag-secondary">From secondary channel</div>
                {{/_secondaryChannel}}
            </ff-record>
        </ff-record-list>
    </div>
</main>

</body>
</html>
