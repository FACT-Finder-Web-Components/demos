<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Two Channel Suggest Demo</title>
    <link rel="stylesheet" href="../assets/demo-styles.css">

    <script src="../node_modules/ff-web-components/dist/vendor/custom-elements-es5-adapter.js"></script>
    <script src="../node_modules/ff-web-components/dist/vendor/webcomponents-loader.js"></script>
    <script defer src="../node_modules/ff-web-components/dist/bundle.js"></script>

    <script>
        const cmsChannel = `Bergfreunde-de`;

        document.addEventListener(`ffCoreReady`, ({ factfinder }) => {
            const defs = factfinder.config.defaults.general;

            defs.url = `https://showcase.ff-labs.de/fact-finder`;
            defs.channel = `Bergfreunde-en`;


            factfinder.request.before.suggest(({ suggestParams, requestOptions }) => {
                const opts = {
                    ...requestOptions,

                    // Stops the pipeline after data is received from FactFinder.
                    // We will start the response pipeline manually.
                    requestOnly: true,

                    // IMPORTANT: As we are issuing suggest requests from the before.suggest handler here,
                    // we must prevent that those requests trigger the handler again which would cause an infinite loop.
                    skipBeforeHandlers: true,
                };

                Promise.all([
                    factfinder.request.suggest(suggestParams, opts),
                    factfinder.request.suggest(suggestParams, { ...opts, channel: cmsChannel }),

                ]).then(([ productResponse, cmsResponse ]) => {
                    const cmsSuggestions = cmsResponse.suggestions
                        .filter(s => s.type === `productName`)
                        .map(s => ({ ...s, type: `content` }));

                    // Merge the two responses as you require.
                    productResponse.suggestions.push(...cmsSuggestions);

                    // Start the response pipeline at the earliest point after receiving data from FactFinder.
                    // All subscribers to the pipeline will be invoked.
                    // We pass the original suggestParams and requestOptions to give this pipeline the same format as the original suggest request.
                    factfinder.response.dispatch.suggest(productResponse, { suggestParams, requestOptions });
                });

                // Interrupt the request pipeline. This pipeline will not issue a request to FactFinder. We do it manually above.
                return false;
            });

        }, { once: true });
    </script>
</head>
<body>

<div class="searchbar">
    <ff-searchbox>
        <input placeholder="Search..."/>
        <ff-searchbutton>
            <button>
                <span class="icon-search"></span>
            </button>
        </ff-searchbutton>
    </ff-searchbox>


    <ff-suggest layout="block" unresolved>
        <section id="searchContainer" class="search-terms-container">
            <div data-container="searchTerm">
                <h2 class="container-caption">Search terms</h2>
                <ff-suggest-item type="searchTerm">
                    <span>{{{name}}}</span>
                </ff-suggest-item>
            </div>

            <div data-container="category">
                <h2 class="container-caption">Categories</h2>
                <ff-suggest-item type="category">
                    <span>{{{name}}}</span>
                </ff-suggest-item>
            </div>

            <div data-container="brand">
                <h2 class="container-caption">Brands</h2>
                <ff-suggest-item type="brand">
                    <span>{{{name}}}</span>
                </ff-suggest-item>
            </div>

            <div data-container="content">
                <h2 class="container-caption">Content (from CMS channel)</h2>
                <ff-suggest-item type="content">
                    <span>{{{name}}}</span>
                </ff-suggest-item>
            </div>
        </section>

        <section id="productContainer" class="products-container">
            <div data-container="productName">
                <h2 class="container-caption">Products</h2>
                <div class="suggest-images">
                    <ff-suggest-item type="productName">
                        <div class="product-image">
                            <img data-image>
                        </div>
                        <div class="product-info">
                            <div class="product-name">{{{name}}}</div>
                        </div>
                    </ff-suggest-item>
                </div>
            </div>
            <div class="all-results-container">
                <ff-searchbutton>
                    <button>Show all results</button>
                </ff-searchbutton>
            </div>
        </section>
    </ff-suggest>
</div>
</body>
</html>
